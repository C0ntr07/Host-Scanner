#pragma once
#include "Stdafx.h"
#include <string>
#include <vector>
#include <unordered_set>
#include <unordered_map>
#include <sqlite3.h>

/*!
 * Represents a CPE dictionary entry.
 */
struct CveEntry
{

	/*!
	 * CVE identifier of the entry.
	 */
	std::string cve;

	/*!
	 * Vulnerability publication date.
	 */
	long date;

	/*!
	 * Summary of the vulnerability.
	 */
	std::string descr;

	/*!
	 * Severity of the vulnerability.
	 */
	float severity;

	/*!
	 * Access vector of the vulnerability.
	 * Possible values are `l` for local, `a` for adjacent and `n` for network.
	 */
	std::string access;

};

/*!
 * Implements the lookup of CPE names in the vulnerability database.
 */
class VulnerabilityLookup
{
public:
	
	/*!
	 * Searches the vulnerability database for entries affecting the specified CPE name.
	 * 
	 * \param cpe CPE name to lookup.
	 * 
	 * \return Matching CVE entries.
	 */
	std::vector<CveEntry> Scan(const std::string& cpe);
	
	/*!
	 * Searches the vulnerability database for entries affecting the specified CPE names.
	 * 
	 * \param cpes CPE names to lookup.
	 * 
	 * \return Matching CVE entries.
	 */
	std::unordered_map<std::string, std::vector<CveEntry>> Scan(const std::vector<std::string>& cpes);

	/*!
	 * Frees up the resources allocated during the lifetime of this instance.
	 */
	~VulnerabilityLookup();

private:

	/*!
	 * Database of CVE entries with their affected product list.
	 */
	sqlite3* db = nullptr;

	/*!
	 * Opens the CVE database.
	 *
	 * \return true if it succeeds, false if it fails.
	 */
	bool openDatabase();

};
